# üì¶ Setup & Installation Guide

## Prerequisites

Before setting up the AI Legal Document Q&A App, ensure you have the following installed:

- **Node.js** (v18 or higher)
- **npm** (v8 or higher)
- **Docker** and **Docker Compose**
- **PostgreSQL** (v14 or higher)
- **Redis** (v6 or higher)

## üöÄ Quick Start

### 1. Clone the Repository

```bash
git clone <repository-url>
cd user-doc-chat
```

### 2. Install Dependencies

```bash
npm install
```

### 3. Generate Secrets

```bash
./scripts/generate-secrets.sh
```

### 4. Deploy with Docker

```bash
docker-compose -f docker-compose.production-secure.yml up -d
```

> üìñ **For detailed setup instructions, see [Secure Deployment Guide](./SECURE_DEPLOYMENT.md)**

---

## üõ†Ô∏è Development Setup

### Environment Configuration

1. **Copy Environment Templates**:
   ```bash
   cp env.example .env.dev    # Development environment
   cp env.example .env.prod   # Production environment
   ```

2. **Configure Environment Variables**:
   Edit `.env.dev` with your development settings:
   ```bash
   # Database
   DATABASE_URL=postgresql://username:password@localhost:5432/user_doc_chat_dev
   
   # Redis
   REDIS_URL=redis://localhost:6379
   
   # JWT Secret (generated by generate-secrets.sh)
   JWT_SECRET=your_generated_jwt_secret
   
   # External APIs
   OPENAI_API_KEY=your_openai_api_key
   ANTHROPIC_API_KEY=your_anthropic_api_key
   ```

### Development Commands

```bash
# Start development server
npm run dev          # Starts both API server and worker
npm run dev:api      # Starts only the API server
npm run worker:dev   # Starts only the file processing worker

# Database operations
npm run migrate:up   # Run pending migrations
npm run migrate:down # Rollback last migration

# Testing
npm test             # Run all tests
npm run test:watch   # Run tests in watch mode
npm run coverage     # Generate test coverage report

# Code quality
npm run lint         # Run ESLint
npm run lint-fix     # Fix ESLint issues
npm run type-check   # TypeScript type checking
```

### Docker Development

#### Quick Setup

```bash
# Start development environment
docker-compose -f docker-compose.dev.yml up --build -d

# View logs
docker-compose -f docker-compose.dev.yml logs -f

# Stop development environment
docker-compose -f docker-compose.dev.yml down
```

#### UID/GID Configuration for Bind Mounts

When using Docker with bind-mounted volumes (like `.:/app`), you may encounter permission issues because the container user doesn't match your host user's UID/GID. The development setup includes automatic UID/GID configuration to resolve this.

**Option 1: Automatic Setup (Recommended)**
```bash
# Run the setup script to automatically configure UID/GID
./scripts/setup-dev-uid.sh

# Then start the development environment
docker-compose -f docker-compose.dev.yml up --build -d
```

**Option 2: Manual Configuration**
```bash
# Get your UID and GID
id -u  # Your UID
id -g  # Your GID

# Set environment variables (add to .env.dev or export)
export UID=$(id -u)
export GID=$(id -g)

# Or add to .env.dev file:
# UID=1000
# GID=1000

# Start development environment
docker-compose -f docker-compose.dev.yml up --build -d
```

**Option 3: Docker Run with User Override**
```bash
# Alternative: Override user at runtime
docker-compose -f docker-compose.dev.yml run --user "$(id -u):$(id -g)" backend
```

> üí° **Why this matters**: Bind-mounted volumes preserve host file ownership. If the container user doesn't match your host UID/GID, you'll get permission denied errors when the application tries to write files.

---

## üè≠ Production Setup

### Build and Deploy

```bash
# Build the application
npm run build

# Start production server
npm run start

# Or use Docker for production
docker-compose -f docker-compose.production-secure.yml up -d
```

### Production Environment Variables

Ensure your production environment has all required variables:

```bash
# Application
NODE_ENV=production
PORT=3000
LOG_LEVEL=info

# Database (with SSL)
DATABASE_URL=postgresql://user:pass@host:5432/db?sslmode=require
DB_HOST=your-production-db-host
DB_PASSWORD=your_secure_db_password

# Redis (with authentication)
REDIS_URL=rediss://user:pass@host:6380
REDIS_PASSWORD=your_secure_redis_password

# JWT (cryptographically secure)
JWT_SECRET=your_secure_jwt_secret

# External APIs
OPENAI_API_KEY=your_production_openai_key
ANTHROPIC_API_KEY=your_production_anthropic_key

# Storage
MINIO_ACCESS_KEY=your_secure_minio_access_key
MINIO_SECRET_KEY=your_secure_minio_secret_key
```

---

## üîê TLS Configuration

The application supports secure gRPC communication between the Node.js backend and Python sanitizer service.

### Development TLS

1. **Generate Development Certificates**:
   ```bash
   ./scripts/generate-dev-certs.sh
   ```

2. **Enable TLS in Development**:
   ```bash
   # In .env.dev
   SANITIZER_TLS_ENABLED=true
   SANITIZER_TLS_CERT_PATH=./certs/dev-cert.pem
   SANITIZER_TLS_KEY_PATH=./certs/dev-key.pem
   ```

### Production TLS

1. **Obtain Production Certificates**:
   - Use your organization's certificate authority
   - Or obtain certificates from a trusted CA

2. **Configure Production TLS**:
   ```bash
   # In .env.prod
   SANITIZER_TLS_ENABLED=true
   SANITIZER_TLS_CERT_PATH=./certs/prod-cert.pem
   SANITIZER_TLS_KEY_PATH=./certs/prod-key.pem
   SANITIZER_TLS_CA_PATH=./certs/ca-cert.pem
   ```

> üìñ **See [Certificate Management](../certs/README.md) for detailed TLS setup instructions**

---

## üêç Python Service Setup (Optional)

The application includes an optional Python service for advanced text sanitization:

### Install Python Dependencies

```bash
# Create virtual environment
python -m venv python_service/venv
source python_service/venv/bin/activate  # On Windows: python_service\venv\Scripts\activate

# Install dependencies
pip install -r python_service/requirements.txt
```

### Run Python Service

```bash
cd python_service
uvicorn main_grpc_server:app --port 8000
```

### Docker Python Service

```bash
# Build and run Python service
docker-compose -f docker-compose.yml up python-service
```

---

## üóÑÔ∏è Database Setup

### PostgreSQL with Vector Extension

1. **Install PostgreSQL**:
   ```bash
   # Ubuntu/Debian
   sudo apt-get install postgresql postgresql-contrib
   
   # macOS
   brew install postgresql
   
   # Docker
   docker run --name postgres -e POSTGRES_PASSWORD=password -p 5432:5432 -d postgres:14
   ```

2. **Install pgvector Extension**:
   ```bash
   # Connect to PostgreSQL
   psql -U postgres
   
   # Create database
   CREATE DATABASE user_doc_chat;
   
   # Connect to database
   \c user_doc_chat;
   
   # Install pgvector extension
   CREATE EXTENSION vector;
   ```

3. **Run Migrations**:
   ```bash
   npm run migrate:up
   ```

### Redis Setup

1. **Install Redis**:
   ```bash
   # Ubuntu/Debian
   sudo apt-get install redis-server
   
   # macOS
   brew install redis
   
   # Docker
   docker run --name redis -p 6379:6379 -d redis:6-alpine
   ```

2. **Configure Redis**:
   ```bash
   # Start Redis
   redis-server
   
   # Test connection
   redis-cli ping
   ```

---

## üîß Configuration Options

### Environment Variables Reference

| Variable | Description | Default | Required |
|----------|-------------|---------|----------|
| `NODE_ENV` | Environment mode | `development` | Yes |
| `PORT` | Server port | `3000` | No |
| `DATABASE_URL` | PostgreSQL connection string | - | Yes |
| `REDIS_URL` | Redis connection string | - | Yes |
| `JWT_SECRET` | JWT signing secret | - | Yes |
| `OPENAI_API_KEY` | OpenAI API key | - | No |
| `ANTHROPIC_API_KEY` | Anthropic API key | - | No |
| `MINIO_ACCESS_KEY` | MinIO access key | - | Yes |
| `MINIO_SECRET_KEY` | MinIO secret key | - | Yes |
| `PINECONE_API_KEY` | Pinecone API key | - | No |
| `HUGGINGFACE_API_KEY` | Hugging Face API key | - | No |

### Docker Configuration

The application includes multiple Docker configurations:

- **`docker-compose.yml`**: Basic setup with all services
- **`docker-compose.dev.yml`**: Development environment with hot reload
- **`docker-compose.production.yml`**: Production environment
- **`docker-compose.production-secure.yml`**: Production with Docker secrets

### Kubernetes Deployment

For Kubernetes deployment, see the `k8s/` directory:

```bash
# Create namespace and secrets
./scripts/setup-k8s-secrets.sh setup

# Deploy to Kubernetes
kubectl apply -f k8s/
```

---

## üß™ Testing Setup

### Unit Tests

```bash
# Run all tests
npm test

# Run tests in watch mode
npm run test:watch

# Run specific test file
npm test -- src/domains/auth/tests/auth.service.test.ts

# Generate coverage report
npm run coverage
```

### Integration Tests

```bash
# Run integration tests
npm run test:integration

# Run E2E tests
npm run test:e2e
```

### Test Database Setup

```bash
# Create test database
createdb user_doc_chat_test

# Run tests with test database
NODE_ENV=test npm test
```

---

## üö® Troubleshooting

### Common Issues

1. **Database Connection Failed**:
   ```bash
   # Check PostgreSQL is running
   sudo systemctl status postgresql
   
   # Check connection string
   echo $DATABASE_URL
   ```

2. **Redis Connection Failed**:
   ```bash
   # Check Redis is running
   redis-cli ping
   
   # Check Redis configuration
   redis-cli config get port
   ```

3. **File Upload Issues**:
   ```bash
   # Check MinIO/S3 configuration
   # Verify access keys and bucket permissions
   # Check file size limits
   ```

4. **Vector Search Not Working**:
   ```bash
   # Check Pinecone configuration
   # Verify API keys and environment
   # Check vector dimensions match
   ```

### Logs and Debugging

```bash
# View application logs
docker-compose logs -f app

# View worker logs
docker-compose logs -f worker

# View all services
docker-compose logs -f

# Debug mode
NODE_ENV=development LOG_LEVEL=debug npm run dev
```

### Performance Issues

1. **Slow Query Responses**:
   - Check Redis cache configuration
   - Verify database indexes
   - Monitor vector search performance

2. **File Processing Delays**:
   - Check BullMQ queue status
   - Monitor worker performance
   - Verify external API rate limits

---

## üìö Additional Resources

- [**Secure Deployment Guide**](./SECURE_DEPLOYMENT.md) - Production deployment with security
- [**API Documentation**](./API.md) - Complete API reference
- [**Architecture Guide**](./ARCHITECTURE.md) - System architecture overview
- [**Features Guide**](./FEATURES.md) - Feature capabilities and use cases

## üÜò Getting Help

If you encounter issues during setup:

1. **Check the logs** for error messages
2. **Verify environment variables** are correctly set
3. **Ensure all services** are running and accessible
4. **Review the documentation** for configuration details
5. **Check system requirements** and dependencies

For additional support, please refer to the project's issue tracker or documentation.
